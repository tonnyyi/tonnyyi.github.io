---
title: JNI开发
tags:
  - jni
  - java
categories:
  - java
date: 2021-06-11 16:27:06
---



java代码由于可以反编译，因此对于一些敏感逻辑，最好使用jni开发。

将开发好的so文件打包进jar文件，[运行时从jar加载](https://xiaoyue26.github.io/2019/09/08/2019-09/JNI%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%BC%95%E7%94%A8so%E6%96%87%E4%BB%B6/)



# 基于Clion开发jnilib

### 1. 定义接口文件

```java
package base.jni;

/**
 * @author <a href=mailto:ktyi@iflytek.com>伊开堂</a>
 * @date 2021/6/11
 */
public class MyService {

    public native String hello(int times, String name);

}
```

### 2. 生成头文件

在编译出来的class文件的根目录（如：`target/classes`目录）执行如下目录，之后会在当前目录生成头文件

```shell
javah base.jni.MyService
```

头文件`base_jni_MyService.h`内容如下

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class base_jni_MyService */

#ifndef _Included_base_jni_MyService
#define _Included_base_jni_MyService
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     base_jni_MyService
 * Method:    hello
 * Signature: (ILjava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_base_jni_MyService_hello
  (JNIEnv *, jobject, jint, jstring);

#ifdef __cplusplus
}
#endif
#endif
```

### 2. 使用Clion创建新项目

项目类型选择`C Excutable`，保持`C99`

### 3. 复制JDK安装目录下的`jni.h`和`jni_md.h`到Clion项目目录

```shell
cd /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/
cp include/jni.h include/darwin/jni_md.h ~/workspakce/clion_jni
```

### 4. 复制idea中的头文件`base_jni_MyService.h`到Clion，修改其内容中的**#include <jni.h>**为**#include "jni.h"**

### 5. 新建`base_jni_MyService.c`并编译

```c
//
// Created by Tonny Yi on 2021/6/11.
//

#include "base_jni_MyService.h"

JNIEXPORT jstring JNICALL Java_base_jni_MyService_hello
        (JNIEnv *env, jobject, jint, jstring) {
    return (*env)->NewStringUTF(env, "Hello...");
}
```

### 6. 编译库，库名称必须是**lib*.jnilib**格式

```shell
gcc base_jni_MyService.c -shared -fPIC -o libtest.jnilib
```

### 7. 复制编译后的库文件到java动态链接库，通过`System.getProperty("java.library.path")`可以获取链接库目录,也可以[自行设置java.library.path的路径](https://blog.csdn.net/quqibing001/article/details/51201768)

```shell
cp libtest.jnilib ~/Library/Java/Extensions
```

也可以在运行代码时指定`java.library.path`

```shell
-Djava.library.path=E:\workspace\StudyJNI\lib
```



最后执行test

```java
public class JniTest {
    static {
        System.loadLibrary("test");
    }

    public static void main(String[] args) {
        System.out.println(new MyService().hello(32, "sss"));
    }

}
```





## 基于IDEA开发so

